<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Life Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --terrible: #b71c1c;
      --bad: #ef6c00;
      --ok: #fdd835;
      --good: #7cb342;
      --great: #1b5e20;
      --past-no-mood: #b0bec5;
      --future-day: #eceff1;
      --today-border: #000000;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      background: #101419;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    header h1 {
      font-size: 1.1rem;
      margin: 0;
    }

    header button {
      background: #1f2933;
      border-radius: 999px;
      padding: 6px 14px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: #f5f5f5;
      font-size: 0.8rem;
    }

    main {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    .stats {
      font-size: 0.8rem;
      line-height: 1.4;
      background: #1a222c;
      border-radius: 10px;
      padding: 10px 12px;
    }

    .stats strong {
      font-weight: 600;
    }

    .grid-wrapper {
      flex: 1;
      min-height: 0;
      background: #151b23;
      border-radius: 10px;
      padding: 8px;
      overflow: auto;
    }

    .day-grid {
      display: grid;
      grid-auto-rows: 9px;
      grid-template-columns: repeat(auto-fill, minmax(9px, 1fr));
      gap: 2px;
    }

    .day-cell {
      width: 9px;
      height: 9px;
      border-radius: 2px;
      background: var(--future-day);
    }

    .day-cell.past-no-mood {
      background: var(--past-no-mood);
    }

    .day-cell.future {
      background: var(--future-day);
    }

    .day-cell.today {
      outline: 1px solid var(--today-border);
      outline-offset: 1px;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      font-size: 0.75rem;
      padding-bottom: 4px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .controls button {
      flex: 1;
      min-width: 120px;
      font-size: 0.8rem;
      padding: 8px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #f9fafb;
    }

    .controls button.secondary {
      background: #111827;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    /* Mood dialog */
    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .backdrop.visible {
      display: flex;
    }

    .dialog {
      background: #0f172a;
      border-radius: 14px;
      padding: 14px 16px;
      width: min(360px, 92vw);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
    }

    .dialog h2 {
      font-size: 1rem;
      margin: 0 0 4px;
    }

    .dialog small {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .mood-label {
      margin-top: 12px;
      margin-bottom: 4px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .mood-label span {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
    }

    input[type="range"] {
      width: 100%;
      margin-top: 6px;
    }

    .mood-names {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      margin-top: 2px;
    }

    .dialog-buttons {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .dialog-buttons button {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
    }

    .dialog-buttons .cancel {
      background: #111827;
      color: #e5e7eb;
    }

    .dialog-buttons .save {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
    }

    .notice {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 4px;
    }
  </style>
</head>
<body>
<header>
  <h1>Life Tracker</h1>
  <button id="changeDobBtn">Change birth date</button>
</header>

<main>
  <section class="stats">
    <div id="dobText"></div>
    <div id="lifeStats"></div>
  </section>

  <section class="grid-wrapper">
    <div class="legend">
      <div class="legend-item">
        <div class="legend-swatch" style="background: var(--terrible)"></div>
        <span>Terrible</span>
      </div>
      <div class="legend-item">
        <div class="legend-swatch" style="background: var(--bad)"></div>
        <span>Bad</span>
      </div>
      <div class="legend-item">
        <div class="legend-swatch" style="background: var(--ok)"></div>
        <span>Okay</span>
      </div>
      <div class="legend-item">
        <div class="legend-swatch" style="background: var(--good)"></div>
        <span>Good</span>
      </div>
      <div class="legend-item">
        <div class="legend-swatch" style="background: var(--great)"></div>
        <span>Great</span>
      </div>
      <div class="legend-item">
        <div class="legend-swatch" style="background: var(--past-no-mood)"></div>
        <span>No mood set</span>
      </div>
    </div>
    <div id="grid" class="day-grid"></div>
  </section>

  <section class="controls">
    <button id="todayMoodBtn">Set today's mood</button>
    <button id="notifyBtn" class="secondary">Try daily reminder</button>
  </section>
  <div class="notice">
    ⚠️ Browser notifications only work while the page / PWA is active.
  </div>
</main>

<!-- Mood dialog -->
<div class="backdrop" id="dialogBackdrop">
  <div class="dialog">
    <h2 id="dialogTitle">How was this day?</h2>
    <small id="dialogDateText"></small>

    <div class="mood-label">
      Mood: <span id="currentMoodLabel">Okay</span>
    </div>

    <input
      type="range"
      id="moodSlider"
      min="0"
      max="4"
      step="1"
      value="2"
    />

    <div class="mood-names">
      <span>Terrible</span>
      <span>Bad</span>
      <span>Okay</span>
      <span>Good</span>
      <span>Great</span>
    </div>

    <div class="dialog-buttons">
      <button class="cancel" id="cancelMoodBtn">Cancel</button>
      <button class="save" id="saveMoodBtn">Save</button>
    </div>
  </div>
</div>

<script>
  const LIFE_YEARS = 80;
  const TOTAL_DAYS = LIFE_YEARS * 365;
  const STORAGE_DOB = "lifeTracker_birthDate";
  const STORAGE_MOODS = "lifeTracker_moods";

  // mood: 0..4
  const moodColors = {
    0: getComputedStyle(document.documentElement).getPropertyValue("--terrible"),
    1: getComputedStyle(document.documentElement).getPropertyValue("--bad"),
    2: getComputedStyle(document.documentElement).getPropertyValue("--ok"),
    3: getComputedStyle(document.documentElement).getPropertyValue("--good"),
    4: getComputedStyle(document.documentElement).getPropertyValue("--great"),
  };

  const moodLabels = {
    0: "Terrible",
    1: "Bad",
    2: "Okay",
    3: "Good",
    4: "Great",
  };

  let birthDate = null; // Date obj (00:00)
  let moods = {}; // { 'YYYY-MM-DD': number }
  let selectedDateKey = null;

  const dobTextEl = document.getElementById("dobText");
  const lifeStatsEl = document.getElementById("lifeStats");
  const gridEl = document.getElementById("grid");
  const changeDobBtn = document.getElementById("changeDobBtn");
  const todayMoodBtn = document.getElementById("todayMoodBtn");
  const notifyBtn = document.getElementById("notifyBtn");

  const dialogBackdrop = document.getElementById("dialogBackdrop");
  const dialogTitleEl = document.getElementById("dialogTitle");
  const dialogDateTextEl = document.getElementById("dialogDateText");
  const currentMoodLabelEl = document.getElementById("currentMoodLabel");
  const moodSlider = document.getElementById("moodSlider");
  const cancelMoodBtn = document.getElementById("cancelMoodBtn");
  const saveMoodBtn = document.getElementById("saveMoodBtn");

  // ---------- helpers ----------

  function formatDateKey(date) {
    return date.toISOString().slice(0, 10);
  }

  function formatDateHuman(date) {
    return date.toLocaleDateString(undefined, {
      year: "numeric",
      month: "short",
      day: "numeric",
    });
  }

  function normalizeDate(d) {
    const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    return nd;
  }

  function daysBetween(start, end) {
    const msPerDay = 24 * 60 * 60 * 1000;
    return Math.floor((normalizeDate(end) - normalizeDate(start)) / msPerDay);
  }

  function loadFromStorage() {
    const dobStr = localStorage.getItem(STORAGE_DOB);
    if (dobStr) {
      const d = new Date(dobStr);
      if (!isNaN(d)) birthDate = normalizeDate(d);
    }

    const moodsStr = localStorage.getItem(STORAGE_MOODS);
    if (moodsStr) {
      try {
        moods = JSON.parse(moodsStr) || {};
      } catch (e) {
        moods = {};
      }
    }
  }

  function saveDob() {
    if (birthDate) localStorage.setItem(STORAGE_DOB, birthDate.toISOString());
  }

  function saveMoods() {
    localStorage.setItem(STORAGE_MOODS, JSON.stringify(moods));
  }

  // ---------- UI ----------

  async function askForDob() {
    const today = new Date();
    let dobInput = prompt("Enter your date of birth (YYYY-MM-DD):", "2000-01-01");
    if (!dobInput) return;

    const parsed = new Date(dobInput);
    if (isNaN(parsed)) {
      alert("Could not understand that date. Try format YYYY-MM-DD.");
      return askForDob();
    }
    if (parsed > today) {
      alert("Birth date cannot be in the future.");
      return askForDob();
    }

    birthDate = normalizeDate(parsed);
    saveDob();
    renderAll();
  }

  function renderStats() {
    if (!birthDate) {
      dobTextEl.textContent = "No birth date set yet.";
      lifeStatsEl.textContent = "";
      return;
    }
    const today = new Date();
    const livedDays = daysBetween(birthDate, today) + 1;
    const totalDays = TOTAL_DAYS;
    const remaining = Math.max(0, totalDays - livedDays);
    const percent = Math.min(100, (livedDays / totalDays) * 100).toFixed(1);

    dobTextEl.innerHTML =
      "<strong>Born:</strong> " + formatDateHuman(birthDate);
    lifeStatsEl.innerHTML =
      `You’ve lived <strong>${livedDays}</strong> days out of about <strong>${totalDays}</strong> ` +
      `(${percent}% of an ${LIFE_YEARS}-year life).<br>` +
      `Approx. days remaining: <strong>${remaining}</strong>`;
  }

  function renderGrid() {
    gridEl.innerHTML = "";
    if (!birthDate) return;

    const today = normalizeDate(new Date());
    const livedDays = daysBetween(birthDate, today) + 1;

    const pastNoMoodColor = getComputedStyle(
      document.documentElement
    ).getPropertyValue("--past-no-mood");
    const futureColor = getComputedStyle(
      document.documentElement
    ).getPropertyValue("--future-day");

    for (let i = 0; i < TOTAL_DAYS; i++) {
      const cellDate = new Date(birthDate);
      cellDate.setDate(cellDate.getDate() + i);
      const key = formatDateKey(cellDate);

      const cell = document.createElement("div");
      cell.className = "day-cell";

      const isPastOrToday = i < livedDays;
      const isToday = i === livedDays - 1;

      if (!isPastOrToday) {
        cell.classList.add("future");
        cell.style.backgroundColor = futureColor;
      } else {
        const moodVal = moods[key];
        if (moodVal === undefined) {
          cell.classList.add("past-no-mood");
          cell.style.backgroundColor = pastNoMoodColor;
        } else {
          cell.style.backgroundColor = moodColors[moodVal];
        }

        cell.addEventListener("click", () => openMoodDialog(cellDate));
      }

      if (isToday) {
        cell.classList.add("today");
      }

      gridEl.appendChild(cell);
    }
  }

  function renderAll() {
    renderStats();
    renderGrid();
  }

  function openMoodDialog(date) {
    selectedDateKey = formatDateKey(date);
    const currentMood =
      moods[selectedDateKey] !== undefined ? moods[selectedDateKey] : 2; // default OK

    moodSlider.value = currentMood;
    currentMoodLabelEl.textContent = moodLabels[currentMood];
    currentMoodLabelEl.style.color = moodColors[currentMood];

    dialogTitleEl.textContent = "How was your day?";
    dialogDateTextEl.textContent = formatDateHuman(date);
    dialogBackdrop.classList.add("visible");
  }

  function closeMoodDialog() {
    dialogBackdrop.classList.remove("visible");
    selectedDateKey = null;
  }

  // ---------- Notifications (limited in browser) ----------

  async function setupDailyNotification() {
    if (!("Notification" in window)) {
      alert("Notifications are not supported on this browser.");
      return;
    }

    let permission = Notification.permission;
    if (permission === "default") {
      permission = await Notification.requestPermission();
    }

    if (permission !== "granted") {
      alert("Notifications were blocked. You can change this in browser settings.");
      return;
    }

    alert(
      "Okay! While this page is open, we'll remind you once a day.\n" +
      "For real background daily notifications, you’d later turn this into a PWA + service worker."
    );

    const targetHour = 20; // 8 PM
    const targetMinute = 0;

    function scheduleLoop() {
      const now = new Date();
      if (now.getHours() === targetHour && now.getMinutes() === targetMinute) {
        new Notification("How was your day?", {
          body: "Tap to open the Life Tracker page and set your mood.",
        });
      }
    }

      // Check every minute
    setInterval(scheduleLoop, 60 * 1000);
  }

  // ---------- event wiring ----------

  changeDobBtn.addEventListener("click", () => {
    askForDob();
  });

  todayMoodBtn.addEventListener("click", () => {
    if (!birthDate) {
      askForDob();
      return;
    }
    const today = normalizeDate(new Date());
    if (today < birthDate) {
      alert("Your birth date is set in the future. Please correct it.");
      return;
    }
    openMoodDialog(today);
  });

  notifyBtn.addEventListener("click", () => {
    setupDailyNotification();
  });

  moodSlider.addEventListener("input", () => {
    const val = parseInt(moodSlider.value, 10);
    currentMoodLabelEl.textContent = moodLabels[val];
    currentMoodLabelEl.style.color = moodColors[val];
  });

  cancelMoodBtn.addEventListener("click", () => {
    closeMoodDialog();
  });

  saveMoodBtn.addEventListener("click", () => {
    if (!selectedDateKey) return;
    const val = parseInt(moodSlider.value, 10);
    moods[selectedDateKey] = val;
    saveMoods();
    closeMoodDialog();
    renderGrid();
  });

  dialogBackdrop.addEventListener("click", (e) => {
    if (e.target === dialogBackdrop) closeMoodDialog();
  });

  // ---------- init ----------

  loadFromStorage();
  if (!birthDate) {
    // First-time users: ask for DOB
    setTimeout(() => {
      askForDob();
    }, 200);
  } else {
    renderAll();
  }
</script>
</body>
</html>
